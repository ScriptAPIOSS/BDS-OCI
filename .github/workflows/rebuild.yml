name: Rebuild
run-name: Rebuilding all images
on:
  workflow_dispatch:
jobs:
  FindVersions:
    name: Find Versions
    outputs:
      STABLE: ${{ steps.versions.outputs.STABLE }}
      VERSIONS: ${{ steps.versions.outputs.VERSIONS }}
    runs-on: ubuntu-latest

    steps:
      - name: "Call versions endpoint"
        uses: indiesdev/curl@v1.1
        id: versions_json
        with:
          url: https://raw.githubusercontent.com/ScriptAPIOSS/BDS-Versions/main/versions.json
          method: "GET"
          accept: 200
          log-response: true

      - name: Extract linux versions
        id: versions
        run: |
          STABLE=`echo '${{ steps.versions_json.outputs.response }}' | jq -r '.data.linux.stable'`
          VERSIONS=`echo '${{ steps.versions_json.outputs.response }}' | jq -r --arg stable "$STABLE" '.data.linux.versions | del(.[] | select(. == ($stable)))'`

          echo "::set-output name=STABLE::${STABLE}"
          echo "::set-output name=VERSIONS::${VERSIONS}"

      - name: Output to summary
        run: |
          echo "Stable: \`${{ steps.versions.outputs.STABLE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Versions:" >> $GITHUB_STEP_SUMMARY
          for v in ${{ steps.versions.outputs.VERSIONS }}; do
            echo " - $v" >> $GITHUB_STEP_SUMMARY
          done

  BuildStable:
    runs-on: ubuntu-latest
    needs: FindVersions
    steps:
      - name:
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'ScriptAPIOSS',
              repo: 'BDS-OCI',
              workflow_id: 'build.yml',
              ref: 'main',
              inputs: {
                BDS_VERSION: '${{ needs.FindVersions.outputs.STABLE }}',
                USE_LATEST_TAG: "true"
              }
            })
